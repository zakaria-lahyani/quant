# ============================================================================
# Trading System - Docker Compose Configuration
# ============================================================================
# Uses env files from ./envs/ folder for clean account configuration
#
# To add a new account:
#   1. Create envs/{account_name}.env (copy from envs/.env.example)
#   2. Create configs/{account_name}/ folder with services.yaml
#   3. Add a new service below using the x-trading-app template
#
# Usage:
#   docker-compose up -d                    # Start all enabled services
#   docker-compose up -d trading-app-funded-next  # Start specific account
#   docker-compose logs -f trading-app-funded-next  # View logs

# ============================================================================
# Shared configuration templates (YAML anchors)
# ============================================================================
x-trading-app: &trading-app-base
  build:
    context: .
    dockerfile: Dockerfile
  networks:
    - trading-network
  depends_on:
    redis:
      condition: service_healthy
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
    interval: 30s
    timeout: 10s
    retries: 3

x-redis-env: &redis-env
  REDIS_HOST: redis
  REDIS_PORT: 6379
  REDIS_DB: 1
  REDIS_PASSWORD: ""

# ============================================================================
# Services
# ============================================================================
services:
  # ==========================================================================
  # Redis - Shared Event Bus
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: trading-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    networks:
      - trading-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Trading App - Funded Next
  # ==========================================================================
  trading-app-funded-next:
    <<: *trading-app-base
    container_name: trading-app-funded-next
    env_file:
      - ./envs/funded_next.env
    environment:
      <<: *redis-env
    volumes:
      - ./configs/funded_next:/app/configs/funded_next:ro
      - ./logs/funded_next:/app/logs

  # ==========================================================================
  # Trading App - ACG Daily
  # ==========================================================================
  trading-app-acg-daily:
    <<: *trading-app-base
    container_name: trading-app-acg-daily
    env_file:
      - ./envs/acg_daily.env
    environment:
      <<: *redis-env
    volumes:
      - ./configs/acg_daily:/app/configs/acg_daily:ro
      - ./logs/acg_daily:/app/logs

  # ==========================================================================
  # Trading App - FTMO Swing
  # ==========================================================================
  trading-app-ftmo-swing:
    <<: *trading-app-base
    container_name: trading-app-ftmo-swing
    env_file:
      - ./envs/ftmo_swing.env
    environment:
      <<: *redis-env
      REDIS_DB: 2  # Different DB for isolation
    volumes:
      - ./configs/ftmo_swing:/app/configs/ftmo_swing:ro
      - ./logs/ftmo_swing:/app/logs


# ============================================================================
# Networks & Volumes
# ============================================================================
networks:
  trading-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
